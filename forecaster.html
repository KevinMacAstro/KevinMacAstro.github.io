<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PFS Exposure Time Forecaster</title>
  <link rel="icon" type="image/png" href="/asterism.png" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .forecast-button {
       background-color: #00f1ff;
       color: #000;
       border: none;
       padding: 10px 16px;
       border-radius: 6px;
       font-weight: bold;
       cursor: pointer;
       transition: background-color 0.3s ease, box-shadow 0.5s ease;
       box-shadow: 0 0 6px rgba(0, 241, 255, 0.5);
      }

     .forecast-button:hover {
        background-color: #00e1ef;
        box-shadow: 0 0 12px rgba(0, 241, 255, 0.8);
      }

 
      .eet-box {
        width: 100%;
        max-width: 450px;
        padding: 20px;
        border: 2px solid var(--accent-glow);
        border-radius: 10px;
        background-color: rgba(0, 0, 0, 0.85);
        box-shadow: 0 0 10px var(--accent-glow);
        color: white;
        font-family: monospace;
        text-align: left;
        transition: all 0.3s ease-in-out;
        }


    .eet-box h3 {
      margin-top: 0;
      text-align: center;
    }
    .eet-box label {
      display: block;
      margin: 0.8em 0 0.2em;
      font-weight: bold;
    }
    .eet-box input, .eet-box select {
      width: 100%;
      padding: 0.4em;
      border-radius: 6px;
      border: 1px solid #888;
      background: #222;
      color: white;
    }

     .eet-box button {
       background-color: #00ccff;
       color: black;
       padding: 10px;
       border: none;
       border-radius: 6px;
       cursor: pointer;
       box-shadow: 0 0 8px var(--accent-glow);
       transition: background-color 0.3s ease, box-shadow 0.3s ease;
     }

     .eet-box button:hover {
       background-color: #00b8e6;
       box-shadow: 0 0 12px var(--accent-glow);
      }

.eet-box button {
  background-color: var(--accent-glow);
  color: black;
  font-family: monospace;
  font-weight: bold;
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: box-shadow 0.3s ease, background-color 0.3s ease;
}

.eet-box button:hover {
  box-shadow: 0 0 5px var(--accent-glow);
}



      .eet-output {
         background-color: rgba(255, 255, 255, 0.05);
         padding: 10px;
         border-radius: 6px;
         margin-top: 10px;
         line-height: 0.5;              /* Tighten vertical spacing */
         min-height: 1.2em;             /* Less reserved height before output */
         font-size: 0.9em;
         font-family: monospace;
         white-space: pre-wrap;
       }

      .eet-output p {
          margin: 2px 0;                 /* Reduce margin between lines if using <p> */
      }
  </style>
</head>

<body>
  <div class="background"></div>
  <div class="asterism"></div>
  <div class="border-line"></div>

  <!-- üîô Back Button -->
  <a href="index.html" class="back-button">
    <div class="back-button-content">
      <img src="back_asterism.png" class="back-icon" alt="Back Icon" />
      <img src="headerFONT_subpage.png" class="back-text" alt="Back Text" />
    </div>
  </a>

  <div class="content-containerF">
    <div class="chat-wrapper">

      <div class="eet-box">
        <h3>PFS Exposure Time Forecaster</h3>
        <label>Target Effective Exposure Time (s)</label>
        <input type="number" id="exp" value="450">
        <label>Confidence Margin (Œ±)</label>
        <input type="number" step="0.1" id="alpha" value="1.0">
        <label>Transparency</label>
        <input type="number" step="0.01" id="transparency" value="0.9">
        <label>Seeing (arcsec)</label>
        <input type="number" step="0.01" id="seeing" value="0.8">
        <label>Airmass</label>
        <input type="number" step="0.01" id="airmass" value="1.2">
        <label>Spectrograph Arm</label>
        <select id="band" style="margin-bottom: 16px;">
          <option value="b">Blue</option>
          <option value="r">Red</option>
          <option value="n">NIR</option>
          <option value="m">Med.</option>
        </select>
        <button onclick="predictEET()">Forecast Exposure Time</button>
        <div class="eet-output" id="output"></div>
        <!-- Version footer -->
        <div style="margin-top: 1em; font-size: 0.85em; color: #666; text-align: right;">
         Version 2 (2025/11/12)
        </div>
      </div>
    </div>
  </div>

<script>
  const coef_dicts = {
    b:{a1: 0.2938184957077484,a2: -1.3923701859470605,a3: -0.6030460871064637,C: 0.8568520682047697,R: 0.05892658322771527,sig: 0.4134561019973598},
    r:{a1: 0.7825132438523126,a2: -1.1756447112703832,a3: -1.255560778029244,C: 1.1038694429679596,R: 0.0542002287218074,sig: 0.4211807927118247},
    n:{a1: -0.15607659629894122,a2: -0.2736233144535924,a3: -0.20076732720898532,C: 0.7001685607118491,R: 0.04208744324400405,sig: 0.2653115012927929},
    m:{a1: 0.5040243787563645,a2: -1.4636465494847783,a3: -1.5528270219306863,C: 1.350848388496214,R: 0.0561467086327467,sig: 0.5650794125230332}
  };

  function predictEET() {
    const exp = parseFloat(document.getElementById('exp').value);
    const alpha = parseFloat(document.getElementById('alpha').value);
    const t = parseFloat(document.getElementById('transparency').value);
    const s = parseFloat(document.getElementById('seeing').value);
    const a = parseFloat(document.getElementById('airmass').value);
    const band = document.getElementById('band').value;
    const coef = coef_dicts[band];

    if ([t, s, a].some(v => isNaN(v) || v <= 0)) {
      document.getElementById('output').innerText = "Invalid input values.";
      return;
    }

    const log_ratio = coef.a1 * Math.log(t) + coef.a2 * Math.log(s) + coef.a3 * Math.log(a) + Math.log(coef.C);
    const ratP = Math.exp(log_ratio) + coef.R;
    const Texp = exp / ratP;
    const adjusted_ratio = ratP - alpha * coef.sig;
    const Texp_err = exp / adjusted_ratio;

    const label = alpha >= 0 ? `eet/exp ‚àí ${alpha}&sigma;` : `eet/exp + ${Math.abs(alpha)}&sigma;`;

    let adjustedText = `<strong>Adjusted Exposure Time (${label}):</strong> ${Texp_err.toFixed(1)} s`;
    let warning = "";
    let warnings = [];

    // Reliability checks
    if (ratP - alpha * coef.sig <= 0) {
      adjustedText = `<strong>Adjusted Exposure Time (${label}):</strong> &infin;`;
      warning += `<div style='color: darkred; margin-top: 0.5em;'>Warning: &alpha; too large ‚Äî Adjusted Time is unreliable</div>`;
    }

    if (ratP < 0.5) {
      warning += `<div style='color: darkorange; margin-top: 0.5em;'>‚ö†Ô∏è  :  Predicted T_exp is unreliable (model extrapolating)!</div>`;
    }
    if (adjusted_ratio < 0.5) {
      warning += `<div style='color: darkorange; margin-top: 0.5em;'>‚ö†Ô∏è  :  Adjusted T_exp is unreliable (model extrapolating)!</div>`;
    }

    // Minimum exp time per visit
    if (Texp < 10) {
      warning += `<div style='color: darkorange; margin-top: 0.5em;'>‚ö†Ô∏è  :  Predicted T_exp < 10s ! [obs. min per visit]</div>`;
    }
    if (Texp_err < 10 && Number.isFinite(Texp_err)) {
      warning += `<div style='color: darkorange; margin-top: 0.5em;'>‚ö†Ô∏è  :  Adjusted T_exp < 10s ! [obs. min per visit]</div>`;
    }

    // Maximum exp time per visit
    if (Texp > 900) {
      warning += `<div style='color: darkorange; margin-top: 0.5em;'>‚ö†Ô∏è  :  Predicted T_exp > 900s ! [obs. limit per visit]</div>`;
    } 
    if (Texp_err > 900) {
      warning += `<div style='color: darkorange; margin-top: 0.5em;'>‚ö†Ô∏è  :  Adjusted T_exp > 900s ! [obs. limit per visit]</div>`;
    }

    let warningHTML = warnings.map(w => `<div class='warn-line'>${w}</div>`).join("");

    document.getElementById('output').innerHTML = `
      <div><strong>Predicted Exposure Time:</strong> ${Texp.toFixed(1)} s</div>
      <div>${adjustedText}</div>
      <div class='warning-block'>${warning}${warningHTML}</div>
    `;
  }
</script>


</body>
</html>


